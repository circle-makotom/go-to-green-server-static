## Hello world (config.0.yml)

まずはブランチを切る. そして, mkdir .circleci して hello world!

ファイル名を間違えてうまく動かない, といった初歩的なトラブルは意外とよくあるので, スモール ステップでここでいったん hello world しておくと気が楽.

## yarn install and yarn build (config.1.yml)

Hello world できたらさっそく意味のある事をする.

そしてここでインストールやビルドのスクリプトが yarn でいい感じになっているということをここで示す.
Makefile とかでまとめてしまうケースもある.

メリットとデメリットの両方があるということを指摘する.

* メリット: ポータビリティが高まる. 手元での実行が楽になる.
* デメリット: CI/CD のオペレーションを定義するファイルが複数に分かれることになってかえって諸々が煩雑になる.

## Rebuilt with SSH (config.2.yml)

ビルドがうまくいかなかった. そんなときは Rebuild with SSH.
スペルミスがあることがすぐわかる.

## キャッシュを実装する (config.3.yml)

後でやってもよいが, 先にやっておけば後々の作業が高速化できるし, こういうのは大体あとでやるといって後になってもやらないのが関の山なので.

## ジョブを時間方向に分離する (config.4.yml)

このままでは実は問題が一つある. それは, 依存関係のインストールがビルドと一緒くたになっていること. これだと, 並行して走らせるジョブもそれぞれ個別に依存関係のインストールをしなくてはならない.

それはよくない, なぜなら:
1. 重複してリソースを消費する.
2. 同じものに対してジョブが動いているという保証ができず, テストの信頼性が下がる.

そこで, 並行するジョブで再利用する可能性のあるものは別ジョブに分けて依存関係を作成する.

つなぎ合わせの部分は workspace を使う.

## テストを並行実行する (config.5.yml)

Webpack の作成と並行して jest のユニット テストを実行する. Webpack の作成とユニット テストはまったく従属関係がないので, 並行実行して時間短縮.

yarn と jest でうまく wrap してあって, 実行するテスト スイートも柔軟に選択できるようになっているのがミソ.
ここをいい感じに実装するかしないかで後々どれくらい柔軟にスケールできるか (テストの規模が大きくなった状況でももテストの分散実行や手元でのテストの選択実行が容易にできるか) が変わってくる.

## デプロイをくっつける (config.6.yml)

まずはデプロイ ジョブを定義.
この辺をエレガントにできるようなインフラ整備が CI/CD の肝になるといっても過言でない.
なぜなら, 変更や機能強化のデプロイ作業の自動化だけでなく, 迅速な修正のリリースやロールバックの高速化とも密接に関係してくるから.
今そのようなインフラがないのであれば, CI/CD をしやすいように, という観点で少しずつインフラ改造を進めていくとよいと思う.
まずは継続デプロイはステージング環境のみ, という進め方でもよいと思う.

次にワークフローを調整. デプロイのジョブの直前に承認のプロセスを入れて, 事故でリリースまで行ってしまうような事態を防げるようにしておく (特にパイプラインのトリガーは実質的に人間が発火させるので, fool-proof として破壊的な変更の前に止められるようにしておくことが重要).
また, main ブランチでのみデプロイが発生するようにすることで, デプロイのタイミングを調整することも可能.
